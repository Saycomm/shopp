<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Account – Tovar qo'shish</title>

  <style>
    body {
      font-family: sans-serif;
      max-width: 1000px;
      margin: 20px auto;
    }

    input, select, button {
      padding: 6px 10px;
      margin: 4px 0;
    }

    form > div {
      margin-bottom: 8px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 1000px;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: left;
      vertical-align: middle;
    }

    th {
      background: #f3f3f3;
    }

    tr:nth-child(even) {
      background: #fafafa;
    }

    .table-img {
      width: 60px;
      height: 60px;
      object-fit: cover;
    }

    .table-img-empty {
      width: 60px;
      height: 60px;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #555;
    }

    .icon-button {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 4px 6px;
    }
    .icon-button:hover {
      transform: scale(1.1);
    }

    .btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .btn-primary {
      background: #007bff;
      margin-right: 10px;
      color: white;
      border-color: #007bff;
    }

    .btn-secondary {
      background: #f3f3f3;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Account: tovar qo'shish / tahrirlash (server bilan)</h1>

    <!-- YANGI TOVAR QO‘SHISH / TAHRIRLASH FORMASI -->
    <form @submit.prevent="onSubmit">
      <div>
        <label>Tovar nomi:</label><br>
        <input v-model="form.name" required style="width: 300px;">
      </div>

      <div>
        <label>Kategoriya:</label><br>
        <select v-model="form.category" required>
          <option disabled value="">Kategoriya tanlang</option>
          <option
            v-for="cat in categories"
            :key="cat"
            :value="cat"
          >
            {{ cat }}
          </option>
        </select>
      </div>

      <div>
        <label>Barcode (shtrix-kod):</label><br>
        <input v-model="form.barcode" required style="width: 200px;">
      </div>

      <div>
        <label>Narx (so'm):</label><br>
        <input type="number" v-model.number="form.price" required style="width: 150px;">
      </div>

      <div>
        <label>
          Rasm (galereyadan tanlash)
          <span v-if="isEditing">(agar almashtirmoqchi bo‘lsang, yangi rasm tanla)</span>
        </label><br>
        <input type="file" accept="image/*" @change="onFileChange">
      </div>

      <div v-if="form.imageData">
        <p>Tanlangan rasm preview:</p>
        <img
          :src="form.imageData"
          alt="tanlangan rasm"
          style="width: 100px; height: 100px; object-fit: cover; border:1px solid #ccc;"
        >
      </div>

      <div style="margin-top: 10px;">
        <button
          type="submit"
          class="btn btn-primary"
        >
          {{ isEditing ? 'O‘zgartirishni saqlash' : 'Tovar qo‘shish' }}
        </button>

        <button
          type="button"
          v-if="isEditing"
          class="btn btn-secondary"
          @click="cancelEdit"
        >
          Bekor qilish
        </button>
      </div>
    </form>

    <hr>

    <h2>Mavjud tovarlar:</h2>

    <div>
      <label>Qidiruv (nomi yoki barcode):</label><br>
      <input
        v-model="search"
        placeholder="masalan: 'zimniy obuv' yoki 123456"
        style="width: 300px;"
      >
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Rasm</th>
          <th>Nomi</th>
          <th>Kategoriya</th>
          <th>Barcode</th>
          <th>Narx (so'm)</th>
          <th>Amal</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(p, index) in filteredProductsAdmin" :key="p.id">
          <td>{{ index + 1 }}</td>
          <td>
            <img
              v-if="p.imageData"
              :src="p.imageData"
              alt="tovar surati"
              class="table-img"
            >
            <div v-else class="table-img-empty">
              Rasm yo'q
            </div>
          </td>
          <td>{{ p.name }}</td>
          <td>{{ p.category }}</td>
          <td>{{ p.barcode }}</td>
          <td>{{ p.price }}</td>
          <td>
            <button
              class="icon-button"
              @click="startEdit(p)"
              title="Tovarni tahrirlash"
            >
              ✏
            </button>
            <button
              class="icon-button"
              @click="deleteProduct(p.id)"
              title="Tovarni o'chirish"
            >
              ❌
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <script>
    const { createApp } = Vue

    createApp({
      data() {
        return {
          categories: [
            'kiyim',
            'elektronika',
            'mebel',
            'oyoq kiyim',
            'aksessuarlar'
          ],
          products: [],
          search: '',

          isEditing: false,
          editId: null,

          form: {
            name: '',
            category: '',
            barcode: '',
            price: null,
            imageData: ''
          }
        }
      },

      computed: {
        filteredProductsAdmin() {
          const s = this.search.toLowerCase().trim()
          if (!s) return this.products

          return this.products.filter(p => {
            const name = p.name ? p.name.toLowerCase() : ''
            const barcode = p.barcode ? String(p.barcode).toLowerCase() : ''
            return name.includes(s) || barcode.includes(s)
          })
        }
      },

      methods: {
        // ✔ Serverdan mahsulotlarni yuklash
        async loadProducts() {
          try {
            const res = await fetch('/api/products')
            this.products = await res.json()
          } catch (err) {
            console.error('Mahsulotlarni yuklash xatosi:', err)
            alert('Mahsulotlarni yuklashda xato bo‘ldi')
          }
        },

        onFileChange(event) {
          const file = event.target.files[0]
          if (!file) return

          const reader = new FileReader()
          reader.onload = (e) => {
            this.form.imageData = e.target.result
          }
          reader.readAsDataURL(file)
        },

        async onSubmit() {
          if (!this.form.name || !this.form.category || !this.form.barcode || this.form.price == null) {
            alert('Barcha majburiy maydonlarni to‘ldiring')
            return
          }

          if (this.isEditing) {
            await this.updateProduct()
          } else {
            await this.addProduct()
          }
        },

        // ✔ yangi tovar – serverga POST
        async addProduct() {
          try {
            const res = await fetch('/api/products', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.form)
            })

            if (!res.ok) {
              const errData = await res.json()
              alert('Xato: ' + (errData.error || res.statusText))
              return
            }

            const created = await res.json()
            this.products.push(created)
            this.resetForm()
            alert('Tovar qo‘shildi!')
          } catch (err) {
            console.error('Tovar qo‘shish xatosi:', err)
            alert('Tovar qo‘shishda xato bo‘ldi')
          }
        },

        startEdit(product) {
          this.isEditing = true
          this.editId = product.id
          this.form = {
            name: product.name,
            category: product.category,
            barcode: product.barcode,
            price: product.price,
            imageData: product.imageData || ''
          }

          const fileInput = document.querySelector('input[type="file"]')
          if (fileInput) fileInput.value = ''
        },

        // ✔ tahrirlash – serverga PUT
        async updateProduct() {
          try {
            const res = await fetch(`/api/products/${this.editId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.form)
            })

            if (!res.ok) {
              const errData = await res.json()
              alert('Xato: ' + (errData.error || res.statusText))
              return
            }

            const updated = await res.json()
            const index = this.products.findIndex(p => p.id === this.editId)
            if (index !== -1) {
              this.products[index] = updated
            }

            this.resetForm()
            this.isEditing = false
            this.editId = null
            alert('O‘zgarishlar saqlandi!')
          } catch (err) {
            console.error('Tovarni yangilash xatosi:', err)
            alert('Tovarni yangilashda xato bo‘ldi')
          }
        },

        // ✔ o‘chirish – serverga DELETE
        async deleteProduct(id) {
          if (!confirm('Rostdan ham bu tovarni o‘chirilsinmi?')) return

          try {
            const res = await fetch(`/api/products/${id}`, {
              method: 'DELETE'
            })

            if (!res.ok) {
              const errData = await res.json()
              alert('Xato: ' + (errData.error || res.statusText))
              return
            }

            this.products = this.products.filter(p => p.id !== id)

            if (this.isEditing && this.editId === id) {
              this.resetForm()
              this.isEditing = false
              this.editId = null
            }
          } catch (err) {
            console.error('Tovarni o‘chirish xatosi:', err)
            alert('Tovarni o‘chirishda xato bo‘ldi')
          }
        },

        cancelEdit() {
          this.resetForm()
          this.isEditing = false
          this.editId = null
        },

        resetForm() {
          this.form = {
            name: '',
            category: '',
            barcode: '',
            price: null,
            imageData: ''
          }
          const fileInput = document.querySelector('input[type="file"]')
          if (fileInput) fileInput.value = ''
        }
      },

      // Sahifa ochilganda serverdan mahsulotlarni yuklab olamiz
      mounted() {
        this.loadProducts()
      }
    }).mount('#app')
  </script>
</body>
</html>
